---
title: "SEII RF Data Task (Mu Yang Shin)"
output: 
  pdf_document:
    latex_engine: pdflatex
documentclass: article
geometry: margin=1in
fontsize: 12pt
header-includes:
   - \usepackage{color, soul}
   - \usepackage{indentfirst}
   - \usepackage{mathptmx}
   - \usepackage{float}
   - \setlength{\parindent}{2em}
   - \setlength{\parskip}{0em}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE, fig.pos = 'H')

library(dplyr)
library(ggplot2)
library(stargazer)
library(plm)
```

```{r data assembling}
# Directory Information -----------------------------------------------------------------
df <- data.frame(ID_IPEDS = integer(),
                 year = integer(),
                 degree_bach = logical(),
                 public = logical())

for (year in 2010:2015) {
  df <- df %>%
    bind_rows(read.csv(paste0("data_raw/hd", year, ".csv"), stringsAsFactors = F) %>%
                rename(ID_IPEDS = UNITID) %>%
                mutate(year = year,
                       
                       # bachelor's degree granting institutions
                       degree_bach = INSTCAT %in% c(2, 3),
                       
                       # public institutions
                       public = SECTOR %in% c(1, 4, 7)) %>%
                
                # Restrict to undergraduate institutions in Tennessee
                filter(UGOFFER == 1,
                       STABBR == "TN") %>%
                
                select(ID_IPEDS, year, degree_bach, public)
    )
}

# Student Financial Aid and Net Price ----------------------------------------------------
df2 <- data.frame(ID_IPEDS = integer(),
                  year = integer(),
                  enroll_futg = integer(),
                  grant_state = double(),
                  grant_federal = double(),
                  netprice = double())

for (year in 2010:2015) {
  year_filename <- (year %% 100) * 101 + 1
  
  df2 <- df2 %>%
    bind_rows(read.csv(paste0("data_raw/sfa", year_filename, ".csv"), stringsAsFactors = F) %>%
                rename(ID_IPEDS = UNITID,
                       
                       # the total number of first-time, full-time undergraduates
                       enroll_futg = SCUGFFN,
                       
                       # total amunt of state and local grant aid awarded to first-time, full-time undergraduates
                       grant_state = SGRNT_T,
                       
                       # total amunt of federal grant aid awarded to first-time, full-time undergraduates
                       grant_federal = FGRNT_T) %>%
                
                mutate(year = year,
                       
                       # the average cost of attendance minus all grant and scholarship aid: NPIST2 (public), NPGRN2(others)
                       netprice = ifelse(is.na(NPGRN2), NPIST2, NPGRN2)) %>%
                
                select(ID_IPEDS, year, enroll_futg, grant_state, grant_federal, netprice)
    )
}

# Merge -----------------------------------------------------------------------------------
df <- df %>%
  left_join(df2, by = c("ID_IPEDS", "year"))

rm(df2)

# Filter for colleges for which data exist in all years
df <- df %>%
  filter(!is.na(enroll_futg), !is.na(grant_state), !is.na(grant_federal), !is.na(netprice)) %>%
  group_by(ID_IPEDS) %>%
  mutate(n = n()) %>%
  ungroup() %>%
  filter(n == 6) %>%
  select(-n)

# Save
write.csv(df, "data_clean/data.csv")
```

```{r construct groups}
# Construct groups
df.by.group <- df %>%
  mutate(group = paste(ifelse(public, "public", "private"), ifelse(degree_bach, "four-year", "two-year"), 
                       sep = ", "),
         group = factor(group)) %>%
  group_by(group, year) %>%
  summarise(avg_grant_state = mean(grant_state), 
            avg_grant_federal = mean(grant_federal),
            total_enroll_futg = sum(enroll_futg),
            avg_netprice = mean(netprice))
```

#### Question 1

```{r question 1, fig.cap = "\\label{fig:fig1}Comparison of Average State Grant Aid across Institution Types", fig.align='center', fig.width = 5, fig.height = 2.5}
# ggplot theme
my_theme <- theme(legend.title = element_blank(), panel.grid.major = element_line(colour = "grey"),
                  panel.grid.minor = element_blank(), panel.background = element_blank(), axis.line = element_line(colour = "black"),
                  legend.position = "right")

ggplot(df.by.group, aes(x = year, y = avg_grant_state, colour = group, shape = group)) +
  geom_line(size = 1) +
  geom_point(size = 3) +
  xlab("Year") +
  ylab("Average State Grant Aid") +
  my_theme
```

* Average state grant aid has been relatively stable, except for public colleges between 2014 and 2015. In 2015, average state grant aid increased for public two-year colleges, but decreased for public four-year colleges.
* The increase in average state grant aid for public two-year colleges can be interpreted as both the increase in average state grant aid per student, and the increase in enrollement.
* On the other hand, assuming that there was no other change in grant aid policy, the decrease for public four-year colleges can be interpreted as the decrease in enrollment of students who would be eligible for state grant aid.

#### Question 2

```{r question 2, fig.cap = "\\label{fig:fig2}Comparison of Total Enrollment of First-Time, Full-Time Undergraduates across Institution Types", fig.align='center', fig.width = 5, fig.height = 2.5}
ggplot(df.by.group, aes(x = year, y = total_enroll_futg, colour = group, shape = group)) +
  geom_line(size = 1) +
  geom_point(size = 3) +
  xlab("Year") +
  ylab("Total Enrollment") +
  my_theme
```

* Enrollment in four-year colleges has been relatively stable, but public two-year colleges experienced a decrease between 2010 and 2012, and a sharp increase between 2014 and 2015. Figure 2 suggests that there are factors other than the program that can influence enrollment in public two-year colleges.
* As observed in Figure 1, enrollment in public four-year colleges declined in 2015. It suggests that the increase in enrollment came not only from students who would have not pursued college education without the program, but also from students who would have enrolled in public four-year colleges.

#### Question 3

```{r question 3, results = 'asis', fig.align='center'}
# Filter for public two-year colleges in 2014 and 2015
df.reg <- df %>% 
  filter(year %in% c(2014, 2015), public == TRUE, degree_bach == FALSE) %>%
  mutate(is_2015 = (year == 2015))

reg.fe <- plm(enroll_futg ~ is_2015, data = df.reg, index = c("ID_IPEDS"), model = "within", effect = "individual")

stargazer(reg.fe,
          title = "Regression Results",
          add.lines = list(c("Fixed Effects", "School")),
          type = "latex", header = FALSE, style = "qje",
          covariate.labels = c("Year 2015"), 
          dep.var.labels = "Enrollment",
          omit.stat = c("adj.rsq"))
```

* Regression model: $y_{it} = \alpha_i + \beta \cdot (year 2015) + \epsilon_{it}$
* This is a one-way fixed effects regression, where $y_{it}$ is enrollment in school $i$ at year $t$, $\alpha_i$ is a time-invariant intercept for each school, and $\beta$ is the effect of the program on enrollment. The regression was run on public two-year colleges in 2014 and 2015.
* The program is estimated to have increased enrollment in public two-year colleges by `r sprintf("%.3f", reg.fe$coefficients)` students on average. 

#### Question 4

* It is likely that this estimate is biased. The regression assumes that the program was the only factor altering differences between 2014 and 2015. In other words, it is assumed that enrollment in 2015 would have not changed without the program. However, as observed in Figure 2, it is very likely that there are other over-time changes, which can create a bias in the estimate when not included as control variables. A difference-in-difference strategy can be employed to obtain a more appropriate counterfactual.

* Figure 2 suggests that some of students who would have enrolled in public four-year colleges enrolled in public two-year colleges instead, which should be noted as diversion rather than as creation.

* This estimate only describes the average effect, but the effects could be heterogeneous within public two-year colleges.

#### Question 5

```{r question 5, fig.cap = "\\label{fig:fig3}Comparison of Average Net Price across Institution Types", fig.align='center', fig.width = 5, fig.height = 2.5}
ggplot(df.by.group, aes(x = year, y = avg_netprice, colour = group, shape = group)) +
  geom_line(size = 1) +
  geom_point(size = 3) +
  xlab("Year") +
  ylab("Average Net Price") +
  my_theme
```

* Between 2014 and 2015, average net price for public two-year colleges was relatively constant, although average state grant aid increased as shown in Figure 1.
* These results suggest that the program did not make public two-year college education much cheaper. It is likely that mechanisms other than cost of attendance were more important. For example, the program could have increased the awareness of the benefits of two-year college education and its low cost of attendance. 
